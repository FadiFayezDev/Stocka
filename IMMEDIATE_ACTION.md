# ?? IMMEDIATE ACTION REQUIRED - ??????? ???????

## ?? ????? ???

?? ?????? **4 ????? ????** ???? ????? Database ??? PostgreSQL:

1. ? GETUTCDATE() ????? ?? NOW()
2. ? SQL Server Unique Filter Syntax
3. ? ApplicationUserId ?????? ?? BrandMemberships
4. ?? Performance Indexes ????????

**Status:** ?? CRITICAL - ??? ??????? ????? ??? ??? Production Deployment

---

## ?? ??????? ??????? (10 ?????)

### Step 1: Backup Database (2 ?????)

```powershell
# ???? ????:

# Option A: pgAdmin UI
# 1. ???? pgAdmin
# 2. Right-click ??? Database
# 3. Backup...
# 4. ???? Custom format
# 5. ???? Backup

# Option B: Command Line
pg_dump -h ep-calm-wave-a9rtyx43-pooler.gwc.azure.neon.tech `
  -U neondb_owner `
  -d neondb `
  -F c `
  -b `
  -v `
  -f "C:\backups\neondb_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').dump"

# Option C: Azure CLI (??? ??? ?????? Azure)
az postgres server backup create `
  --resource-group your-rg `
  --server-name your-server `
  --backup-name "before-migration-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
```

### Step 2: Stop Application (1 ?????)

```powershell
# ???? ????:

# Option A: Stop IIS
iisreset /stop

# Option B: Stop Service
net stop "Your Service Name"

# Option C: Terminate Process
Stop-Process -Name "dotnet" -Force

# ??????
Get-Process | Where-Object {$_.Name -eq "dotnet"}  # should be empty
```

### Step 3: Open Package Manager Console (1 ?????)

```
In Visual Studio:
1. Tools ? NuGet Package Manager ? Package Manager Console
2. Set Default Project to "Infrastructure"
3. Set Default Database = AppDbContext
```

### Step 4: Apply Migration (3 ?????)

```powershell
# Copy & Paste ?? Package Manager Console:

# Step 4a: Build
dotnet build

# Step 4b: Create Migration (if first time)
Add-Migration FixPostgreSQLCompatibility

# Step 4c: Review Generated Migration
# File: Infrastructure/Migrations/20260216020000_FixPostgreSQLCompatibility.cs
# Check if it looks correct

# Step 4d: Apply to Database
Update-Database
```

### Step 5: Verify (2 ?????)

```powershell
# ?? PowerShell ?? pgAdmin SQL Console:

$ConnectionString = "Host=ep-calm-wave-a9rtyx43-pooler.gwc.azure.neon.tech;Database=neondb;Username=neondb_owner;Password=...;SSL Mode=Require;"

# ????? ??? ??? Queries:

# Check 1: ApplicationUserId ?????
SELECT COUNT(*) as "ApplicationUserId_Exists"
FROM information_schema.columns
WHERE table_name = 'brand_memberships' 
AND column_name = 'application_user_id';
-- Expected Result: 0

# Check 2: Indexes ??????
SELECT COUNT(*) as "Performance_Indexes"
FROM pg_indexes
WHERE indexname LIKE '%PurchaseDate%' 
OR indexname LIKE '%OrderDate%'
OR indexname LIKE '%CreatedAt%';
-- Expected Result: >= 5

# Check 3: Default Values ?????
SELECT column_default
FROM information_schema.columns
WHERE table_name = 'employees'
AND column_name = 'hire_date';
-- Expected Result: now()

# Check 4: Unique Constraints ??????
SELECT indexdef
FROM pg_indexes
WHERE tablename = 'customers'
AND indexname LIKE 'ix_customers_user%';
-- Expected Result: shows correct PostgreSQL syntax with "user_id"
```

### Step 6: Start Application (1 ?????)

```powershell
# ???? ????:

# Option A: Start IIS
iisreset /start

# Option B: Start Service
net start "Your Service Name"

# Option C: Run API Project
# ?? Visual Studio: F5 ?? Debug > Start Debugging

# ??????
Invoke-WebRequest -Uri "http://localhost:5000/health" -Method Get
```

---

## ? ?????? ??????

### Green Flags ?
```
? Build completed without errors
? Add-Migration created the new file
? Update-Database executed successfully
? All 5 verification queries returned expected results
? Application started without errors
? No "The entity type 'BrandUser' requires a primary key" errors
```

### Red Flags ?
```
? Build failed
? Migration script has errors
? Update-Database timed out
? Verification queries return NULL/0 unexpected
? Application won't start
? Foreign key constraint violations
```

---

## ?? Troubleshooting Quick Links

### Problem: Migration Failed
```powershell
# Rollback
Update-Database -Migration 20260216010405_InitialCreate

# Try again
Add-Migration FixPostgreSQLCompatibility
Update-Database
```

### Problem: Unique Constraint Violation
```sql
-- Drop old bad index
DROP INDEX IF EXISTS ix_customers_user_id;
DROP INDEX IF EXISTS ix_employees_user_id;

-- Recreate with correct syntax
CREATE UNIQUE INDEX ix_customers_user_id 
ON customers("user_id") 
WHERE "user_id" IS NOT NULL;
```

### Problem: Connection String Issue
```powershell
# Test connection
psql -h ep-calm-wave-a9rtyx43-pooler.gwc.azure.neon.tech `
  -U neondb_owner `
  -d neondb `
  -c "SELECT version();"
```

---

## ?? ????? ??????

```
????????????????????????????????????????
? Step 1: Backup (2 min) ........... ?
? Step 2: Stop App (1 min) ......... ?
? Step 3: Open PMC (1 min) ......... ?
? Step 4: Apply Migration (3 min) . ?
? Step 5: Verify (2 min) ........... ?
? Step 6: Start App (1 min) ........ ?
????????????????????????????????????????
? Total Time: ~10 minutes
? Database Downtime: ~2-3 minutes
? Risk Level: LOW (Backup Available)
????????????????????????????????????????
```

---

## ?? ??????? ????????

### ?????? ?? ????????? ????:

1. **POSTGRESQL_MIGRATION_FIX.md** (??? ???????)
   ```
   - ???? ??????? ??????
   - ????? ????
   - ????? ???? ??????
   ```

2. **DATABASE_MIGRATION_GUIDE.md** (???? ????)
   ```
   - ????? ?????
   - ?????? ?????
   - ??????? ???????
   ```

3. **CONFIGURATION_CHECK.md** (????????? ????????)
   ```
   - Configurations ???? ????? ?????
   - ????? ??????
   - Best practices
   ```

---

## ?? ?????? ?????? ?????? ??

### ????? - ASAP (?????)
- [ ] ????? ??????? 1-6 ????? (10 ?????)
- [ ] ?????? ?? Success

### ????
- [ ] ????? ???? ??? Tests
- [ ] ?????? Database Performance

### ??? ???????
- [ ] ????? Configurations (??? ???)
- [ ] Optimize Indexes
- [ ] Monitor slow queries

---

## ?? ???? ?????? ???????

???? ????:

### Option 1: Safe Route (???? ??)
```
? Backup ? ???? ???
? Stop App
? Apply Migration
? Verify in SQL
? Start App
? Run Tests
```

### Option 2: Quick Route (??? Development ???)
```
?? Skip Backup (not recommended)
? Stop App
? Apply Migration
? Start App
```

### Option 3: Rollback Plan
```
? Restore Backup (if needed)
```

---

## ?? ??????? ????

```
?? ??? Migration ??? ?? ???? ??? ?? Production Deployment
?? ??? ?????? ????? ??? Database Errors
?? ???????? ???????? ???? - ?? ?????
?? ??? Backup ????? ??? Rollback ??? ??? ?????
```

---

## ? ??? ????????

```
??? ???? ???? ???????:

? PostgreSQL compatible ?
? All indexes in place ?
? Performance optimized ?
? Data intact ?
? Ready for Production ?

?? ??! ????? ???? deploying safely
```

---

## ?? ????? ????

??? ????? ?????:

```
? Q: ?? ????? ???????
? A: ?? - Backup ????? ? Migration ???

? Q: ?? ????? ????????
? A: ~10 ?????

? Q: ?? ??? ????? ??? API?
? A: ??? - ??? ?? ???? race conditions

? Q: ???? ??? ??? Migration?
? A: ?????? ?? Backup ????? ??????
```

---

**??????:** ?? ???? ??????? ??????  
**?????:** 10 ?????  
**???????:** ?????? (Backup ?????)  
**???????:** ???? ??? ??????? ????? ????
