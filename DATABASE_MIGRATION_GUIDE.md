# ?? Database Migration - ???? ????

## ?? ?????????

1. [??????? ????????](#???????-????????)
2. [?????? ???????](#??????-???????)
3. [????? ???????](#?????-???????)
4. [?????? ?????????](#??????-?????????)
5. [??????? ???????](#???????-???????)

---

## ?? ??????? ????????

### ??????? 1: SQL Server Functions ?? PostgreSQL
**?????:** Database ?? ???? ???? ????

| ??????? | SQL Server | PostgreSQL | ??? ??????? |
|---------|-----------|-----------|-----------|
| Date/Time Default | `GETUTCDATE()` | `NOW()` | 8 cases |
| Unique Filter | `[column] IS NULL` | `"column" IS NULL` | 2 cases |

### ??????? 2: ApplicationUserId ??????
**?????:** Foreign Key constraints ????? ???? ?????

```
BrandMemberships Table:
??? FK ? AspNetUsers.Id (via UserId) ?
??? FK ? AspNetUsers.Id (via ApplicationUserId) ? redundant
```

### ??????? 3: ??? ???? Performance Indexes
**?????:** Queries ????? ??? ????? ?????

```
Missing Indexes:
??? Purchases.PurchaseDate
??? Orders.OrderDate
??? Expenses.ExpenseDate
??? JournalEntries.EntryDate
??? StockMovements.CreatedAt
??? Composite indexes ??? BrandId + Date columns
```

---

## ? ?????? ???????

### Migration: FixPostgreSQLCompatibility

**?????:** `Infrastructure/Migrations/20260216020000_FixPostgreSQLCompatibility.cs`

**?????????:**

```csharp
// 1. ??? ??? Indexes ??? ???????
migrationBuilder.DropIndex("IX_Customers_UserId", "Customers");
migrationBuilder.DropIndex("IX_Employees_UserId", "Employees");

// 2. ??? ?????? ??????
migrationBuilder.DropColumn("ApplicationUserId", "BrandMemberships");

// 3. ????? ????? ??? Indexes ???????? ???????
migrationBuilder.CreateIndex(
    "IX_Customers_UserId",
    "Customers",
    "UserId",
    filter: "\"UserId\" IS NOT NULL");

// 4. ????? Audit Columns
migrationBuilder.AddColumn<DateTime>("UpdatedAt", "Products");
migrationBuilder.AddColumn<DateTime>("UpdatedAt", "Purchases");
migrationBuilder.AddColumn<DateTime>("UpdatedAt", "Orders");

// 5. ????? Performance Indexes
migrationBuilder.CreateIndex("IX_Purchases_PurchaseDate", "Purchases", "PurchaseDate");
migrationBuilder.CreateIndex("IX_Orders_BrandId_OrderDate", "Orders", 
    new[] { "BrandId", "OrderDate" });
```

---

## ?? ????? ???????

### ??????? 1: ??????? (Pre-Application)

#### 1.1 Backup Database
```bash
# Option 1: ???????? pgAdmin
# Right-click Database ? Backup

# Option 2: ???????? Command Line
pg_dump -h host -U username dbname > backup.sql

# Option 3: ???????? Azure CLI (??? ??? ?????? Azure)
az postgres server backup create --resource-group rg --server-name srv --backup-name before-migration
```

#### 1.2 Stop Application
```bash
# ????? IIS Application Pool ?? ????? ??? API Server
net stop "Application Service Name"
```

#### 1.3 ?????? ?? ???????
```powershell
# ?? Package Manager Console
$connectionString = "Host=...;Database=...;Username=...;Password=..."
psql -U username -h hostname -d dbname -c "SELECT version();"
```

### ??????? 2: ????? Migration

#### 2.1 ????? Migration
```powershell
# ?? Package Manager Console
# Set Default Project to Infrastructure
Add-Migration FixPostgreSQLCompatibility
```

#### 2.2 ?????? Migration
```powershell
# ???? ?? ??? ??? Migration ???? ?? ??????
# ???? ?? ????:
# - DropIndex for old indexes
# - DropColumn for ApplicationUserId
# - CreateIndex with correct PostgreSQL syntax
# - AddColumn for UpdatedAt
```

#### 2.3 ????? ??? Database
```powershell
# ???? ???? pending migrations
Update-Database

# ?? ????? migration ????
Update-Database -Migration FixPostgreSQLCompatibility
```

### ??????? 3: ?????? (Post-Application)

#### 3.1 ?????? ?? ?????????
```sql
-- 1. ???? ?? ??? ApplicationUserId
SELECT COUNT(*) 
FROM information_schema.columns
WHERE table_name = 'brand_memberships'
AND column_name = 'application_user_id';
-- Expected: 0

-- 2. ???? ?? ??? Indexes ???????
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename IN ('customers', 'employees')
AND indexname LIKE 'IX_%UserId%';

-- 3. ???? ?? Default Values
SELECT column_name, column_default
FROM information_schema.columns
WHERE table_name = 'employees'
AND column_name = 'hire_date';
-- Expected: now()

-- 4. ???? ?? UpdatedAt columns
SELECT column_name
FROM information_schema.columns
WHERE table_name IN ('products', 'purchases', 'orders')
AND column_name = 'updated_at';
-- Expected: 3 columns
```

#### 3.2 ?????? ?? Data Integrity
```sql
-- ???? ?? Unique Constraints
SELECT constraint_name, table_name, column_name
FROM information_schema.key_column_usage
WHERE constraint_type = 'UNIQUE'
ORDER BY table_name, column_name;

-- ???? ?? Foreign Keys
SELECT constraint_name, table_name, column_name
FROM information_schema.referential_constraints
WHERE table_name = 'brand_memberships';
-- Expected: 2 FKs only (not 3)
```

#### 3.3 ?????? ??? Application
```csharp
// ?? Test Project
public void TestDatabaseMigration()
{
    using (var context = new AppDbContext(_options))
    {
        // Test 1: Create Brand
        var brand = new Brand { /* ... */ };
        context.Brands.Add(brand);
        context.SaveChanges();
        Assert.IsTrue(brand.CreatedAt > DateTime.MinValue);
        
        // Test 2: Create BrandMembership (???? ApplicationUserId)
        var membership = new BrandMembership 
        { 
            BrandId = brand.Id,
            UserId = userId,
            Role = "Manager"
        };
        context.BrandMemberships.Add(membership);
        context.SaveChanges();
        
        // Test 3: Create Employee with default values
        var employee = new Employee { /* ... */ };
        context.Employees.Add(employee);
        context.SaveChanges();
        Assert.IsTrue(employee.HireDate > DateTime.MinValue);
        Assert.IsTrue(employee.IsActive);
    }
}
```

### ??????? 4: Start Application
```bash
# Start IIS Application Pool ?? API Server
net start "Application Service Name"
```

---

## ?? ?????? ?????????

### Test Case 1: Unique Constraints
```sql
-- ??? ?? ????
INSERT INTO customers (id, user_id, brand_id, loyalty_points)
VALUES (gen_random_uuid(), NULL, brand_id1, 0);

-- ??? ?? ???? (Unique violation)
INSERT INTO customers (id, user_id, brand_id, loyalty_points)
VALUES (gen_random_uuid(), user_id1, brand_id1, 0);
INSERT INTO customers (id, user_id, brand_id, loyalty_points)
VALUES (gen_random_uuid(), user_id1, brand_id2, 0);
```

### Test Case 2: Default Values
```sql
-- HireDate ??? ?? ???? ????
INSERT INTO employees (id, user_id, brand_id, job_title, is_active)
VALUES (gen_random_uuid(), NULL, brand_id, 'Manager', DEFAULT);

SELECT hire_date FROM employees WHERE id = last_inserted_id;
-- Expected: current timestamp
```

### Test Case 3: Foreign Keys
```sql
-- ??? ?? ????
INSERT INTO brand_memberships (brand_id, user_id, role)
VALUES (brand_id, user_id, 'Manager');

-- ??? ?? ????
INSERT INTO brand_memberships (brand_id, user_id, role)
VALUES (invalid_brand_id, user_id, 'Manager');
```

---

## ?? ??????? ???????

### ????? 1: "Unique Violation on UserId"
**?????:** Duplicate unique index
**????:**
```sql
DROP INDEX IF EXISTS ix_customers_user_id_old;
CREATE UNIQUE INDEX ix_customers_user_id 
ON customers("user_id") 
WHERE "user_id" IS NOT NULL;
```

### ????? 2: "Column ApplicationUserId does not exist"
**?????:** Migration ?? ???? ???? ????
**????:**
```powershell
Update-Database -Migration InitialCreate
Update-Database -Migration FixPostgreSQLCompatibility
```

### ????? 3: "NOW() is not defined"
**?????:** PostgreSQL functions ??? ????
**????:**
```sql
-- ???? ?? Database
SELECT version();

-- ???? ?? ??? extensions
SELECT * FROM pg_extension;
```

### ????? 4: "Index already exists"
**?????:** Migration ????? ??????
**????:**
```powershell
# ???? ?? Applied Migrations
Get-Migration

# ??? ???? ????? ??????? ????
```

---

## ?? ???? ?????????

| ??????? | ????? | ?????? |
|--------|------|--------|
| Drop old indexes | Migration | ? |
| Drop ApplicationUserId | Migration | ? |
| Create new indexes | Migration | ? |
| Add UpdatedAt columns | Migration | ? |
| Add performance indexes | Migration | ? |

---

## ? ????? ?????? ????????

??? ??????? ???????:

- [ ] Backup ?? ???? ?????
- [ ] Migration ?? ??????? ???? errors
- [ ] ???? ??? Indexes ??????
- [ ] Default Values ?????
- [ ] Foreign Keys ?????
- [ ] Unique Constraints ?????
- [ ] Application ???? ???? errors
- [ ] Tests ???? 100%
- [ ] Database Performance ????

---

## ?? ????? ?????????

### ??????? ???????:

**Q: ??? ????? ?? Migration Status?**
```powershell
Get-Migration -Context AppDbContext
```

**Q: ??? ???? Migration ?????**
```powershell
Update-Database -Migration PreviousMigration
```

**Q: ??? ???? ??? Migration?**
```powershell
Update-Database -Migration PrePreviousMigration
Remove-Migration
```

**Q: ??? ??? Database Diagram ???????**
```sql
SELECT * FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;
```

---

**??????:** ? ???? ???????  
**??? ?????:** ????  
**???????:** 1.0
