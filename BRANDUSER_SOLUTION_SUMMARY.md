# ? ???? ?? ????? BrandUser

## ?? ??????? ????????

```
Unable to create a 'DbContext' of type 'AppDbContext'. 
The exception 'The entity type 'BrandUser' requires a primary key to be defined.'
```

---

## ?? ???? ??????

### 1. ? ????? BrandUserConfiguration

**?????:** `Infrastructure/Configurations/BrandUserConfiguration.cs`

```csharp
public class BrandUserConfiguration : IEntityTypeConfiguration<BrandUser>
{
    public void Configure(EntityTypeBuilder<BrandUser> builder)
    {
        // ? Composite Primary Key
        builder.HasKey(bu => new { bu.BrandId, bu.UserId });

        // ? Foreign Key Relationships
        builder.HasOne(bu => bu.Brand)
            .WithMany()
            .HasForeignKey(bu => bu.BrandId)
            .OnDelete(DeleteBehavior.Cascade);

        builder.HasOne(bu => bu.User)
            .WithMany(u => u.BrandUsers)
            .HasForeignKey(bu => bu.UserId)
            .OnDelete(DeleteBehavior.Cascade);

        // ? Property Configuration
        builder.Property(bu => bu.Role)
            .IsRequired()
            .HasMaxLength(100);
    }
}
```

### 2. ? ????? DbSet ?? AppDbContext

**?????:** `Infrastructure/Contexts/AppDbContext.cs`

```csharp
public virtual DbSet<BrandUser> BrandUsers { get; set; }
```

**???????:** EF Core ????? Configuration ???????? ??? ??????? `ApplyConfigurationsFromAssembly()`

---

## ?? ?? ?? ??????

| ????? | ?????? | ??????? |
|--------|--------|---------|
| **Code Fix** | ? | 2 files modified |
| **Build** | ? | Successful |
| **Configuration** | ? | BrandUserConfiguration.cs |
| **Documentation** | ? | 2 new files |
| **Testing** | ? | Guidelines provided |

---

## ?? ??????? ???????

### ?? Modified Files (2)
```
?? Infrastructure/Contexts/AppDbContext.cs
   ?? Added: public virtual DbSet<BrandUser> BrandUsers { get; set; }

?? Infrastructure/Configurations/BrandUserConfiguration.cs
   ?? New file with proper configuration
```

### ?? Documentation Files (2)
```
?? Infrastructure/BRANDUSER_FIX.md
   ?? ??? ??????? ????? ????????

?? Infrastructure/BRANDUSER_TESTING.md
   ?? ????? ???????? ? Unit Tests
```

---

## ?? ??????? ???????

### Step 1: ????? Build
```bash
dotnet build
```
? **???????:** Build successful

### Step 2: ????? Migration
```powershell
# ?? Package Manager Console
Add-Migration AddBrandUserConfiguration
```

### Step 3: ????? Migration
```powershell
Update-Database
```

### Step 4: ??????
```sql
-- ?? SQL Server
SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'BrandUsers'
```

---

## ?? ?????????

### Database Design
```
? Composite Primary Key: (BrandId, UserId)
? Foreign Keys: ????? ?? Cascade Delete
? Constraints: Role ????? ? MaxLength 100
? Table: BrandUsers ???? ?????? ???? ????
```

### Type Safety
```
? Entity: ????? ???? ????
? Configuration: ??????? ?? Entity
? DbSet: ????? ?? AppDbContext
? Relationships: ??????
```

### Data Integrity
```
? Primary Key: ???? ??? ???????
? Foreign Keys: ????? ??? Referential Integrity
? Cascades: ??? ?????? ??? ??? Parent
? Required Fields: Role ????? ??????
```

---

## ?? ?????? ????

### Code Test
```csharp
// ? ??? ?? ????
var options = new DbContextOptionsBuilder<AppDbContext>()
    .UseInMemoryDatabase("test")
    .Options;

using (var context = new AppDbContext(options))
{
    // ? BrandUser ????? ???? ????
    var brandUser = new BrandUser 
    { 
        BrandId = Guid.NewGuid(),
        UserId = Guid.NewGuid(),
        Role = "Manager"
    };
    
    context.BrandUsers.Add(brandUser);
    context.SaveChanges(); // ? ???? errors
}
```

---

## ? ??? ? ???

### Before ?
```csharp
// BrandUser ???? ????? Primary Key
public class BrandUser
{
    public Guid BrandId { get; set; }
    public Guid UserId { get; set; }
    public string Role { get; set; }
}

// DbContext ???? ????? BrandUser
public class AppDbContext
{
    // public DbSet<BrandUser> BrandUsers { get; set; } ? ?????
}

// ???? Configuration
// ? Error: requires a primary key to be defined
```

### After ?
```csharp
// BrandUser ????? ???? ????
public class BrandUser
{
    public Guid BrandId { get; set; }
    public Guid UserId { get; set; }
    public string Role { get; set; }
}

// DbContext ?? ??????? ??????
public class AppDbContext
{
    public virtual DbSet<BrandUser> BrandUsers { get; set; }
}

// Configuration ?????
public class BrandUserConfiguration : IEntityTypeConfiguration<BrandUser>
{
    public void Configure(EntityTypeBuilder<BrandUser> builder)
    {
        builder.HasKey(bu => new { bu.BrandId, bu.UserId });
        // ... rest of configuration
    }
}

// ? Build successful
// ? Database ready
// ? Type safe
```

---

## ?? ?????? ?????????

### 1. Every Entity Needs a Primary Key
```
? Composite Keys: (Column1, Column2)
? Simple Keys: Id property
? Keyless Entities: Call HasNoKey() explicitly
```

### 2. Register DbSet in DbContext
```csharp
// ? ??? ????? ???? Entities
public DbSet<Entity> Entities { get; set; }
```

### 3. Create Configuration for Each Entity
```csharp
// ? Configuration ???? Type Safety
public class EntityConfiguration : IEntityTypeConfiguration<Entity>
{
    public void Configure(EntityTypeBuilder<Entity> builder)
    {
        builder.HasKey(...);
        // ... complete configuration
    }
}
```

### 4. ApplyConfigurationsFromAssembly() Loads All
```csharp
// ? ???? ???? IEntityTypeConfiguration implementations
modelBuilder.ApplyConfigurationsFromAssembly(
    typeof(AppDbContext).Assembly);
```

---

## ?? ?????

### ??? ????? ?????:

1. **Build Errors**: ???? `BRANDUSER_FIX.md`
2. **Migration Issues**: ???? `MIGRATION_STEPS.md`
3. **Testing**: ?????? ????? ?? `BRANDUSER_TESTING.md`

---

## ? Checklist ??? ????????

- [x] ?? ????? BrandUserConfiguration
- [x] ?? ????? DbSet ?? AppDbContext
- [x] Build ? Successful
- [x] ?? ???? CS errors
- [ ] Migration ?? ??????? (?????? ???????)
- [ ] Database ?? ??????? (?????? ???????)
- [ ] ?????? ???????? (?????? ???????)

---

## ?? ??????? ????????

```
????????????????????????????????????????
?   ? Problem Solved Successfully    ?
????????????????????????????????????????
? ? Build: SUCCESSFUL                 ?
? ? Configuration: PROPER              ?
? ? Type Safety: GUARANTEED            ?
? ? Database: READY FOR MIGRATION      ?
? ? Documentation: COMPLETE            ?
????????????????????????????????????????
```

---

**??????:** ? ????? ? ???? ??? Production Migration

**??? ?????:** ????

**??????? ?????????:** 
- ? Infrastructure/Configurations/BrandUserConfiguration.cs
- ? Infrastructure/BRANDUSER_FIX.md
- ? Infrastructure/BRANDUSER_TESTING.md

**?????????:**
- ? Infrastructure/Contexts/AppDbContext.cs
