# Domain Layer Improvements - ??????? ???? ??? Domain

## ?? ???? ?????????

?? ????? ???? **Domain Models** ?? ??????? ?????? **Business Logic ????** ? **Validation** ???? ??? Entities ????? ?? ???????? ??? ??? POCOs ??????? (Plain Old C# Objects).

---

## ? ??????? ???????

### 1. **Validation ???? ??? Constructor**
?? entity ???? ????? ?? ??? ???????? ??? ???????:

```csharp
// ????: ExpenseCategory
public ExpenseCategory(Guid brandId, string name)
{
    if (string.IsNullOrWhiteSpace(name))
        throw new ArgumentException("Expense category name cannot be empty.", nameof(name));
    
    BrandId = brandId;
    Name = name.Trim();
}
```

### 2. **Methods ??????? ????????? ????????**
????? ?? ????? ??????? ??????? ???? methods ????? ?? ??? ????????:

```csharp
// ????: Customer
public void AddLoyaltyPoints(int points)
{
    if (points <= 0)
        throw new ArgumentException("Points to add must be greater than zero.", nameof(points));
    
    LoyaltyPoints += points;
}

public void DeductLoyaltyPoints(int points)
{
    if (points <= 0)
        throw new ArgumentException("Points to deduct must be greater than zero.", nameof(points));
    
    if (points > LoyaltyPoints)
        throw new InvalidOperationException("Insufficient loyalty points.");
    
    LoyaltyPoints -= points;
}
```

### 3. **Collection Management Methods**
?? entity ???? collection ???? ???:

```csharp
// ????: Purchase
public void AddPurchaseItem(PurchaseItem item)
{
    if (item == null)
        throw new ArgumentNullException(nameof(item));
    
    if (item.PurchaseId != Id)
        throw new ArgumentException("Purchase item does not belong to this purchase.");
    
    if (_purchaseItems.Any(pi => pi.Id == item.Id))
        throw new InvalidOperationException("Purchase item already added.");
    
    _purchaseItems.Add(item);
    RecalculateTotal();
}
```

### 4. **Business Rule Enforcement**
- **Batch**: ?????? ?? ?? ?????? ???????? ?? ??? ?? ???????
- **Sale**: ?????? ?? ???? ????? ??? ????? ?? ??? items
- **SaleItem**: ?????? ?? ?? ??? ????? ?? ??? ?? ??? ???????
- **JournalEntry**: ?????? ?? ????? ?????? ???????
- **Employee**: ?????? ?? ?? ?????? ???? ??????? ??????? ??? ??????

### 5. **Helper Methods ? Properties**
?? entity ????? ??? methods ?????? ???????? ?????????:

```csharp
// ????: SaleItem
public decimal GetProfit() => (UnitPrice - CostPrice) * Quantity;
public decimal GetTotalPrice() => UnitPrice * Quantity;

// ????: Batch
public bool IsExhausted => RemainingQuantity == 0;
public decimal GetTotalCost() => InitialQuantity * UnitCost;

// ????: JournalEntry
public decimal GetTotalDebit => _journalEntryLines.Sum(l => l.Debit);
public decimal GetTotalCredit => _journalEntryLines.Sum(l => l.Credit);
public bool IsBalanced => GetTotalDebit == GetTotalCredit;
```

---

## ?? Entities ????????

### **Core Entities**
- ? **Branch**: UpdateName, AddWarehouse, RemoveWarehouse
- ? **Customer**: AddLoyaltyPoints, DeductLoyaltyPoints, AddSale
- ? **Employee**: UpdateJobTitle, UpdateSalary, Deactivate, Activate

### **Product Entities**
- ? **Product**: UpdateName, UpdateBarcode, AddBatch
- ? **ProductCategory**: UpdateName, AddProduct, RemoveProduct
- ? **Batch**: DeductQuantity, AddQuantity, IsExhausted
- ? **Warehouse**: UpdateName, ChangeType, AddStockMovement
- ? **WarehouseBatch**: AddQuantity, DeductQuantity, IsEmpty
- ? **StockMovement**: IsInbound, IsOutbound

### **Purchasing Entities**
- ? **Supplier**: UpdateName, UpdateContactInfo, ValidateEmail
- ? **Purchase**: AddPurchaseItem, RemovePurchaseItem, RecalculateTotal
- ? **PurchaseItem**: UpdateQuantity, UpdateUnitCost, AddBatch

### **Sales Entities**
- ? **Sale**: AddSaleItem, RemoveSaleItem, CancelSale, ReturnSale
- ? **SaleItem**: UpdateQuantity, UpdateUnitPrice, GetProfit, GetTotalPrice

### **Accounting Entities**
- ? **Account**: UpdateName, AddJournalEntryLine
- ? **JournalEntry**: UpdateDescription, AddJournalEntryLine, RemoveJournalEntryLine, ValidateBalance
- ? **JournalEntryLine**: UpdateDebit, UpdateCredit, GetAmount

### **Expense Entities**
- ? **Expense**: UpdateAmount, UpdateNotes, UpdateExpenseDate
- ? **ExpenseCategory**: UpdateName, AddExpense

---

## ?? Clean Architecture Benefits

1. **Encapsulation**: Logic ??? ???? ???? ??? Entity
2. **Single Responsibility**: ?? method ?? ??????? ????? ?????
3. **Validation**: ?????? ???? ?? ???? ???? (??? Domain)
4. **Testability**: ???? ?????? Business Rules ??????
5. **Maintainability**: ????????? ??? ??? Rules ???? ?? ???? ????

---

## ?? ??? ?????????

### ? ??????? ??????? (POCOs)
```csharp
var expense = new Expense();
expense.Amount = -100; // ?? ???? validation!
expense.CategoryId = Guid.Empty; // ?? ???? ??? ??????
```

### ? ??????? ??????? (Rich Domain Models)
```csharp
// ????? ??? Constructor ?? Validation
var expense = new Expense(brandId, categoryId, amount, expenseDate, notes);

// ?? ????? ??? Methods ?? Validation
expense.UpdateAmount(newAmount); // ????? ??? ??? ?????? <= 0
```

---

## ?? Safety Features

- **Null Checks**: ???? parameters ?????? ????? ?? null
- **Range Validation**: ??????? ???????? ??? ?? ???? ?????
- **State Validation**: ???????? ????? ?? ?????? ??????? (??? Sale Status)
- **Relationship Validation**: ??? ?????? ?? ?? ??? items ????? ??? parent ??????
- **Balance Validation**: ???????? ????????? ????? ?? ???????

---

## ?? ???????? ??????? ?????????

1. **Domain Exceptions**: ????? custom exception class ??? Domain
   ```csharp
   public class DomainException : Exception { }
   ```

2. **Value Objects**: ????? ???????? ??????? ???????? ??? Value Objects
   ```csharp
   public class Money { public decimal Amount { get; } }
   public class Quantity { public int Count { get; } }
   ```

3. **Domain Events**: ????? domain events ???????? ??????
   ```csharp
   public class SaleCompletedEvent : DomainEvent { }
   ```

4. **Specifications Pattern**: ?? complex queries
   ```csharp
   public interface ISpecification<T> { }
   ```

---

## ?? ??????? ????????

- ? `Domain/Entities/Core/Branch.cs`
- ? `Domain/Entities/Core/Customer.cs`
- ? `Domain/Entities/Core/Employee.cs`
- ? `Domain/Entities/Products/Product.cs`
- ? `Domain/Entities/Products/ProductCategory.cs`
- ? `Domain/Entities/Products/Batch.cs`
- ? `Domain/Entities/Products/Warehouse.cs`
- ? `Domain/Entities/Products/WarehouseBatch.cs`
- ? `Domain/Entities/Products/StockMovement.cs`
- ? `Domain/Entities/Purchasing/Supplier.cs`
- ? `Domain/Entities/Purchasing/Purchase.cs`
- ? `Domain/Entities/Purchasing/PurchaseItem.cs`
- ? `Domain/Entities/Sales/Sale.cs`
- ? `Domain/Entities/Sales/SaleItem.cs`
- ? `Domain/Entities/Accounting/Account.cs`
- ? `Domain/Entities/Accounting/JournalEntry.cs`
- ? `Domain/Entities/Accounting/JournalEntryLine.cs`
- ? `Domain/Entities/Expenses/Expense.cs`
- ? `Domain/Entities/Expenses/ExpenseCategory.cs`
