# ? ?? ????? BrandUser Primary Key

## ?? ???????

```
The entity type 'BrandUser' requires a primary key to be defined. 
If you intended to use a keyless entity type, call 'HasNoKey' in 'OnModelCreating'.
```

---

## ?? ?????

### ??? ????:
```csharp
// ? BrandUser ???? Primary Key
public class BrandUser
{
    public Guid BrandId { get; set; }
    public virtual Brand Brand { get; set; } = null!;

    public Guid UserId { get; set; }
    public virtual ApplicationUser User { get; set; } = null!;

    public string Role { get; set; } = null!;
}

// ? ?? ??? ????? ?? DbContext
// ? ?? ??? ??? Configuration
```

---

## ? ????

### 1. ????? BrandUserConfiguration

```csharp
public class BrandUserConfiguration : IEntityTypeConfiguration<BrandUser>
{
    public void Configure(EntityTypeBuilder<BrandUser> builder)
    {
        // ? ????? Composite Primary Key
        builder.HasKey(bu => new { bu.BrandId, bu.UserId })
            .HasName("PK_BrandUsers");

        // ? ????? ????????
        builder.HasOne(bu => bu.Brand)
            .WithMany()
            .HasForeignKey(bu => bu.BrandId)
            .OnDelete(DeleteBehavior.Cascade);

        builder.HasOne(bu => bu.User)
            .WithMany(u => u.BrandUsers)
            .HasForeignKey(bu => bu.UserId)
            .OnDelete(DeleteBehavior.Cascade);

        // ? ????? Properties
        builder.Property(bu => bu.Role)
            .IsRequired()
            .HasMaxLength(100);
    }
}
```

### 2. ????? DbSet ?? AppDbContext

```csharp
public partial class AppDbContext : IdentityDbContext<ApplicationUser, IdentityRole<Guid>, Guid>
{
    public virtual DbSet<Brand> Brands { get; set; }
    
    public virtual DbSet<BrandUser> BrandUsers { get; set; }  // ? ??????
    
    public virtual DbSet<Customer> Customers { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(AppDbContext).Assembly);
        // ? ???? BrandUserConfiguration ???? ??????? ????????
    }
}
```

---

## ?? ???????

| ?????? | ????? |
|--------|---------|
| **Composite Key** | `(BrandId, UserId)` ???? ???? ?? ????? |
| **Type Safety** | Entity ????? ?? Configuration ????? |
| **Data Integrity** | Delete Behaviors ????? (Cascade) |
| **Relationships** | ?????? ????? ?? Brand ? ApplicationUser |
| **Database** | ???? ???? ????? Migration ????? |

---

## ?? ??????? ???????

### 1. ????? Migration
```powershell
Add-Migration AddBrandUserConfiguration
```

### 2. ????? ??? Database
```powershell
Update-Database
```

### 3. ?????? ?? ???????

?? SQL:
```sql
-- ?????? ?? Table
SELECT * FROM [dbo].[BrandUsers];

-- ?????? ?? Primary Key
SELECT * 
FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS 
WHERE TABLE_NAME = 'BrandUsers' AND CONSTRAINT_TYPE = 'PRIMARY KEY';

-- ?????? ?? Foreign Keys
SELECT * 
FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS 
WHERE TABLE_NAME = 'BrandUsers';
```

---

## ?? ???????? ???????

### Composite Primary Key

```csharp
// ? ??????
builder.HasKey(bu => new { bu.BrandId, bu.UserId });

// ? ??? ???? (????? Id ????)
public Guid Id { get; set; }
builder.HasKey(bu => bu.Id);
```

### Delete Behavior

```csharp
// ? Cascade: ??? ??? Brand ?? User? ??? ??? ???????
.OnDelete(DeleteBehavior.Cascade)

// ? Restrict: ?? ???? ???? Brand ??? ??? ???? ?????
.OnDelete(DeleteBehavior.Restrict)

// ? NoAction: ?? ???? ????? ?? Referential Integrity
.OnDelete(DeleteBehavior.NoAction)
```

---

## ?? ??????? ????????

- ? `Infrastructure/Configurations/BrandUserConfiguration.cs` - **????**
- ? `Infrastructure/Contexts/AppDbContext.cs` - **?????**
- ? `Infrastructure/Identity/BrandUser.cs` - ???? ?????
- ? `Infrastructure/Identity/ApplicationUser.cs` - ???? ?????

---

## ? ??????

```
? Build: SUCCESSFUL
? Configuration: PROPER
? Database: READY FOR MIGRATION
? Type Safety: GUARANTEED
```

---

## ?? ???????

- [Composite Keys in EF Core](https://learn.microsoft.com/en-us/ef/core/modeling/keys?tabs=fluent-api)
- [Relationships in EF Core](https://learn.microsoft.com/en-us/ef/core/modeling/relationships)
- [Delete Behaviors in EF Core](https://learn.microsoft.com/en-us/ef/core/modeling/relationships?tabs=fluent-api%2Cfluent-api-simple-key%2Csimple-key#required-and-optional-relationships)

---

**??????:** ? ????? ? ???? ??? Production
