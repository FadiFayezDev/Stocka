# ?? ????? ??????? ?????? - Fix Remaining Issues

## ?? ????? ?????????: 10 ?????

---

## ?????? 1: ??????? (2 ?????)

### 1.1 Backup Database
```powershell
# ?? PowerShell
pg_dump -h your-host -U your-user -d your-db > backup_before_v2.sql
```

### 1.2 Stop Application
```powershell
# ???? ??? Application
net stop "Service Name"
# ?? ?? Visual Studio: Debug > Stop Debugging
```

### 1.3 Open Package Manager Console
```
Tools ? NuGet Package Manager ? Package Manager Console
Set Default Project to: Infrastructure
```

---

## ?????? 2: ????? Migration (3 ?????)

### 2.1 Build Project
```powershell
# ?? PMC
dotnet build
```

### 2.2 ????? Migration ??????
```powershell
# ???? ????:

# Option 1: ????? Migration ??????
Update-Database -Migration "FixRemainingPostgreSQLIssues"

# Option 2: ????? ???? pending migrations
Update-Database

# Option 3: ????? ?? verbose output
Update-Database -Verbose
```

### 2.3 ????? ???????
```
??? ?? ??? ????? ???? ???:
Executed DbCommand (XXXms) [Parameters=[], CommandType='Text']
ALTER TABLE "orders" ALTER COLUMN "order_date" SET DEFAULT now();
...
Done.
```

---

## ?????? 3: ?????? (3 ?????)

### 3.1 SQL Verification Queries

??? pgAdmin ?? psql ????? ??? ??? Queries:

#### Query 1: ???? ?? NOW() ????? ?? GETUTCDATE()
```sql
SELECT column_name, column_default
FROM information_schema.columns
WHERE table_name = 'employees' AND column_name = 'hire_date';
-- Expected: now()
```

#### Query 2: ???? ?? Index Filter Syntax
```sql
SELECT indexdef FROM pg_indexes
WHERE tablename = 'customers' 
AND indexname = 'ix_customers_user_id';
-- Expected: ??? ?? ????? ??? "user_id" (?? quotes!)
-- ???: CREATE UNIQUE INDEX ix_customers_user_id ON customers("user_id") WHERE ("user_id" IS NOT NULL)
```

#### Query 3: ???? ?? ???? UserPhoneNumbers
```sql
SELECT COUNT(*) FROM information_schema.tables
WHERE table_name = 'user_phone_numbers';
-- Expected: 1 (?????? ?????)
```

#### Query 4: ???? ?? Performance Indexes
```sql
SELECT COUNT(*) as IndexCount
FROM pg_indexes
WHERE indexname LIKE 'ix_%_order_date%'
OR indexname LIKE 'ix_%_created_at%'
OR indexname LIKE 'ix_%_purchase_date%'
OR indexname LIKE 'ix_%_entry_date%'
OR indexname LIKE 'ix_%_expense_date%'
OR indexname LIKE 'ix_%_hire_date%';
-- Expected: >= 11
```

#### Query 5: ???? ?? Composite Indexes
```sql
SELECT COUNT(*) as CompositeIndexCount
FROM pg_indexes
WHERE indexname LIKE 'ix_%_brandid_%';
-- Expected: >= 4
```

---

## ?????? 4: Build & Test (2 ?????)

### 4.1 Build
```powershell
# ?? PMC
dotnet build

# ??? ?? ???: ? Build succeeded.
```

### 4.2 Run Tests (Optional)
```powershell
# ??? ??? ???? unit tests
dotnet test
```

---

## ?????? 5: Start Application (1 ?????)

### 5.1 Start Application
```powershell
# Option 1: Start Service
net start "Service Name"

# Option 2: ?? Visual Studio
F5  # Debug > Start Debugging

# Option 3: ?? Terminal
dotnet run
```

### 5.2 Verify Application
```powershell
# ???? ?? ??????? ???? ???? errors
# ???? ?? ??? API endpoints ????
Invoke-WebRequest -Uri "http://localhost:5000/health"
```

---

## ? ?????? ??????

```
?? ??? ?? ??? ALL ??? ??? checkmarks:

? Build completed without errors
? Update-Database executed successfully
? SQL verification queries return expected results
? No "GETUTCDATE()" errors in logs
? No "syntax error" in Postgres logs
? Application starts without errors
? API endpoints respond normally
```

---

## ? ?????? ????? (???????)

### ? Migration failed: "syntax error"

**?????:** GETUTCDATE() ?? ??????

**????:**
```powershell
# ???? ??? commit ??????
Update-Database -Migration 20260216011843_InitialCreate

# ???? ?? ???????
Get-Migration

# ???? ??? ????
Update-Database
```

### ? "column default not found"

**?????:** ????? ?? ?????

**????:**
```powershell
# ???? ?? ???? ??? migration
Get-Migration -Context AppDbContext

# ??? ???????
Update-Database -Verbose
```

### ? "Index already exists"

**?????:** Migration ????? ??????

**????:**
```powershell
# ?? ???? - ??? ??????
# Migration idempotent - ???? ?????? ???? ?? ???
# ?????? ?????
```

### ? Application won't start

**?????:** ?? ???? ????? Database

**????:**
```powershell
# ???? ?? Connection String ?? appsettings.json
# ???? ?? ?? Database ????
# ????:
psql -h your-host -U your-user -d your-db -c "SELECT 1;"
```

---

## ?? Rollback (??? ?????)

```powershell
# ???? ?????? ??????? ?? Migration
Update-Database -Migration 20260216011843_InitialCreate

# ?? ??? ???? ?????? ??????:
Update-Database -Migration 0  # ??? ???? migrations

# ?????? ?? Backup
psql -h your-host -U your-user -d your-db < backup_before_v2.sql
```

---

## ?? Quick Check List

### ??? ?????
- [ ] Backup taken
- [ ] App stopped
- [ ] PMC opened
- [ ] Infrastructure selected as default project

### ????? ???????
- [ ] Build successful
- [ ] Update-Database executed
- [ ] No errors in output

### ??? ???????
- [ ] SQL verification queries passed
- [ ] Build successful again
- [ ] App starts without errors
- [ ] API responds to requests

---

## ?? ??? ????? ??????

### ????? ?????:

**Q: ??? ????? ?? Migration status?**
```powershell
Get-Migration -Context AppDbContext
```

**Q: ??? ???? SQL commands ???? ??????**
```powershell
Update-Database -Verbose
```

**Q: ?? ???? ?????? ??? production ???????**
```
???! ???? ?????? (?? backup ?????)
```

**Q: ?? ????? ??????**
```
~2-3 ????? (??? ??? Database)
```

---

## ?? ??? ????????

```
? ?? ??????? ??????
? Database PostgreSQL compatible
? Performance optimized (11+ indexes)
? ???? ??? Production

?? ???????! Done Successfully!
```

---

**??????:** ?? ????? ??????? ??????  
**?????:** 10 ?????  
**???????:** ?????? (Backup ?????)  
**???????:** 100% issue fixed
