# ????? ????? ? ????? Database Migration

## ?? ????????? ????????

??? ?????? ???? ?? ?? ????:
- ? .NET 10 SDK ????
- ? SQL Server ?? LocalDB ????
- ? Visual Studio ?? VS Code
- ? Package Manager Console ????

---

## ?? ????? ????? Migration

### ?????? 1: ??? Package Manager Console
```
View ? Other Windows ? Package Manager Console
```

?? ?? Terminal:
```powershell
# ???? ??? ?? ???? ??? ???? .sln file
cd D:\Main Projects\Stocka
```

### ?????? 2: ????? Migration ????
```powershell
# ???? Default Project = Infrastructure

Add-Migration UpdateConfigurationsForStrongModels

# ?? ??? ??? ?????? dotnet CLI:
dotnet ef migrations add UpdateConfigurationsForStrongModels -p Infrastructure -s API
```

### ?????? 3: ?????? Migration File
??? ????? ?????? ???? ????? file ??:
```
Infrastructure/Migrations/[timestamp]_UpdateConfigurationsForStrongModels.cs
```

???? ??:
- ? ???? ??? Tables ????? ???? ????
- ? Default Values ?????
- ? Foreign Keys ?????
- ? Indexes ?????
- ? Not Null Constraints ?????

### ?????? 4: ????? Migration ??? Database
```powershell
# ????? ??? migration
Update-Database

# ?? ??? ??? ?????? dotnet CLI:
dotnet ef database update -p Infrastructure -s API
```

---

## ? ?????? ?? ???????

### 1. ?????? ?? Tables
```sql
-- ?? SQL Server Management Studio
SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_SCHEMA = 'dbo'
ORDER BY TABLE_NAME;
```

### 2. ?????? ?? Columns ?? Purchases (????):
```sql
SELECT COLUMN_NAME, IS_NULLABLE, COLUMN_DEFAULT, DATA_TYPE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'Purchases'
ORDER BY ORDINAL_POSITION;
```

??? ?? ???:
- ? `Id` - NOT NULL
- ? `PurchaseDate` - DEFAULT getutcdate()
- ? `TotalAmount` - DEFAULT 0
- ? `BrandId` - NOT NULL
- ? `SupplierId` - NOT NULL

### 3. ?????? ?? Foreign Keys:
```sql
SELECT CONSTRAINT_NAME, TABLE_NAME, REFERENCED_TABLE_NAME
FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS
WHERE TABLE_SCHEMA = 'dbo'
ORDER BY CONSTRAINT_NAME;
```

### 4. ?????? ?? Indexes:
```sql
SELECT OBJECT_NAME(i.object_id) AS TableName,
       i.name AS IndexName,
       i.type_desc AS IndexType
FROM sys.indexes i
WHERE OBJECTPROPERTY(i.object_id, 'IsUserTable') = 1
ORDER BY TableName, IndexName;
```

---

## ?? ??? ??? ??? ?? Migration

### ????? ??? Migration:
```powershell
# ???? Migration ?? Database ? Project
Remove-Migration

# ?? ??? ??? ?????? dotnet CLI:
dotnet ef migrations remove -p Infrastructure -s API
```

### ?????? ??? Migration ????:
```powershell
# ????? migration ????
Update-Database -Migration PreviousMigration

# ?? ??? ??? ?????? dotnet CLI:
dotnet ef database update PreviousMigration -p Infrastructure -s API
```

### ??? ?? Migrations ?????? ?? ????:
```powershell
# ??? ?? Migrations ?? ?????? ??????
# ?? ??? Database
Drop-Database

# ????? ?????
Add-Migration InitialCreate
Update-Database
```

---

## ?? ????: Expected Changes ?? Customer Table

### Before:
```sql
CREATE TABLE Customers (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    UserId UNIQUEIDENTIFIER UNIQUE,
    BrandId UNIQUEIDENTIFIER,
    LoyaltyPoints INT  -- ???? default
);
```

### After:
```sql
CREATE TABLE Customers (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    UserId UNIQUEIDENTIFIER UNIQUE FILTERED,
    BrandId UNIQUEIDENTIFIER,
    LoyaltyPoints INT DEFAULT 0,  -- ? ?? default value
    FOREIGN KEY (BrandId) REFERENCES Brands(Id),
    FOREIGN KEY (UserId) REFERENCES AspNetUsers(Id)
);
```

---

## ??? Troubleshooting

### ???????: "Failed to create shadow database"
**????:**
```powershell
# ???? ?? ????? ?? ????????? ?? Database
# ?? ???? ??? ????
Update-Database
```

### ???????: "The model backing the context has changed"
**????:**
```powershell
# ????? migration ????
Add-Migration FixModelChanges
Update-Database
```

### ???????: "Foreign key constraint"
**????:**
1. ???? ?? ?? ??? Default Project ?? Infrastructure
2. ???? ?? ?? ???? Configurations ?????
3. ???? ??? Migration ???? ????????

---

## ? ???? ?????????

### 1. ????? Migrations ???? ????:
```powershell
Add-Migration UpdateConfigurationsForStrongModels
# ? ???? ??????

Add-Migration Migration123
# ? ??? ????
```

### 2. Squash Migrations (??? ??? ?????):
```powershell
# ???? ??? migrations ?? ?????
Add-Migration CombinedMigrations --no-build
```

### 3. Backup Database ??? Update:
```powershell
# (?? SQL Server Management Studio)
# Right-click Database ? Tasks ? Back Up
```

### 4. ??????? Transactions:
```csharp
using (var transaction = context.Database.BeginTransaction())
{
    try
    {
        context.Database.Migrate();
        transaction.Commit();
    }
    catch
    {
        transaction.Rollback();
        throw;
    }
}
```

---

## ?? ???? ??????? ???????

```powershell
# 1. ??? Package Manager Console
# (View ? Other Windows ? Package Manager Console)

# 2. ???? ?? ?????? Default Project: Infrastructure

# 3. ????? Migration
Add-Migration UpdateConfigurationsForStrongModels

# 4. ????? ??? Database
Update-Database

# 5. ?????? ?? ???????
# (?????? SQL Server Management Studio)
```

---

## ?? ??????? ????????

??? ????? Migration ?????? ????? ????:

? ???? **Default Values** ????? ?? Database  
? ???? **Required Fields** ?????? ?? NOT NULL  
? ???? **Collections** ????? ???? ????  
? ???? **Delete Behaviors** ?????  
? ???? **Indexes** ?????? ??? Performance  
? ???? **Enum Values** ?????? ?? Strings  

---

## ?? ????? ??????

- [EF Core Migrations Documentation](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [EF Core Configuration](https://learn.microsoft.com/en-us/ef/core/modeling/entity-properties)
- [Delete Behaviors in EF Core](https://learn.microsoft.com/en-us/ef/core/modeling/relationships?tabs=fluent-api%2Cfluent-api-simple-key%2Csimple-key#required-and-optional-relationships)
