# ?? ?????? ?????? ??????? ???????? - Migration 20260216011843

## ?? ????? ????

**?????? ???????:** 8.3% ?????? ??? ?  
**?????? ???????:** ???? ??? 100% ?

---

## ?? ??????? ???????? ?? InitialCreate

### 1?? GETUTCDATE() ??? ?????? (7 ?????)

#### ???????
```csharp
// ? SQL Server function - ?? ???? ?? PostgreSQL
defaultValueSql: "GETUTCDATE()"
```

#### ??????? ????????
```
1. Employees.HireDate ?
2. JournalEntries.EntryDate ?
3. Orders.OrderDate ?
4. Expenses.ExpenseDate ?
5. Purchases.PurchaseDate ?
6. Batches.CreatedAt ?
7. StockMovements.CreatedAt ?
```

#### ????
```csharp
// ? PostgreSQL function
defaultValueSql: "NOW()"
```

**???????:** ?????????? ????? ??? ??????? ??? PostgreSQL

---

### 2?? Index Filter Syntax ???? (2 ?????)

#### ???????
```csharp
// ? SQL Server bracket syntax
filter: "[UserId] IS NOT NULL"
```

#### ??????? ????????
```
1. Customers.UserId index ?
2. Employees.UserId index ?
```

#### ????
```csharp
// ? PostgreSQL quote syntax
filter: "\"UserId\" IS NOT NULL"
```

**???????:** ??? Unique Index ?? ??? ??????? ???? ????

---

### 3?? ????? ?? ????? ???? UserPhoneNumber

#### ???????
```csharp
// ??????
name: "UserPhoneNumber"

// ??? Constraints ?????? ??? "Numbers"
table.PrimaryKey("PK_UserPhoneNumbers", x => x.Id);  // ? s ??????

// ???? Foreign Key
name: "FK_UserPhoneNumbers_Users_ApplicationUserId"  // ? Users ?? AspNetUsers

// ???? Index
name: "IX_UserPhoneNumber_ApplicationUserId"  // ? ?? ????
```

#### ????
```csharp
// ????? ???????
name: "UserPhoneNumbers"  // ? ?? s
name: "FK_UserPhoneNumbers_AspNetUsers_ApplicationUserId"  // ? ????
```

**???????:** ??? ????? ?? naming conventions ?? ???? ?????

---

### 4?? ApplicationUserId ?????? ?? BrandMemberships

#### ???????
```csharp
BrandId = table.Column<Guid>(...),       // ? ????
UserId = table.Column<Guid>(...),        // ? ????
ApplicationUserId = table.Column<Guid>(...) // ? ????!

// ???? 3 foreign keys!
FK: BrandMemberships -> Brands
FK: BrandMemberships -> AspNetUsers (UserId)
FK: BrandMemberships -> AspNetUsers (ApplicationUserId)  // ? ????!
```

#### ????
???:
- **Option A:** ??? `ApplicationUserId` (??????)
- **Option B:** ??????? ???? ???

**???????:** ????? ??? ????? ?? FK ?????

---

## ? ?????? ??????? (Migration ??????)

### Migration: FixRemainingPostgreSQLIssues

**?????:** `Infrastructure/Migrations/20260216030000_FixRemainingPostgreSQLIssues.cs`

---

## ?? ????????? ????????

### 1. ????? GETUTCDATE() (7 ?????? AlterColumn)

```csharp
// Employees.HireDate
migrationBuilder.AlterColumn<DateTime>(
    name: "HireDate",
    table: "Employees",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");

// JournalEntries.EntryDate
migrationBuilder.AlterColumn<DateTime>(
    name: "EntryDate",
    table: "JournalEntries",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");

// Orders.OrderDate
migrationBuilder.AlterColumn<DateTime>(
    name: "OrderDate",
    table: "Orders",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");

// Expenses.ExpenseDate
migrationBuilder.AlterColumn<DateTime>(
    name: "ExpenseDate",
    table: "Expenses",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");

// Purchases.PurchaseDate
migrationBuilder.AlterColumn<DateTime>(
    name: "PurchaseDate",
    table: "Purchases",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");

// Batches.CreatedAt
migrationBuilder.AlterColumn<DateTime>(
    name: "CreatedAt",
    table: "Batches",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");

// StockMovements.CreatedAt
migrationBuilder.AlterColumn<DateTime>(
    name: "CreatedAt",
    table: "StockMovements",
    defaultValueSql: "NOW()",
    oldDefaultValueSql: "GETUTCDATE()");
```

### 2. ????? Index Filters

```csharp
// Drop old indexes
migrationBuilder.DropIndex("IX_Customers_UserId", "Customers");
migrationBuilder.DropIndex("IX_Employees_UserId", "Employees");

// Recreate with PostgreSQL syntax
migrationBuilder.CreateIndex(
    name: "IX_Customers_UserId",
    table: "Customers",
    column: "UserId",
    unique: true,
    filter: "\"UserId\" IS NOT NULL");  // ? PostgreSQL syntax

migrationBuilder.CreateIndex(
    name: "IX_Employees_UserId",
    table: "Employees",
    column: "UserId",
    unique: true,
    filter: "\"UserId\" IS NOT NULL");  // ? PostgreSQL syntax
```

### 3. ????? ????? ????? UserPhoneNumber

```csharp
// Rename table
migrationBuilder.RenameTable(
    name: "UserPhoneNumber",
    newName: "UserPhoneNumbers");

// Rename constraints
migrationBuilder.RenameIndex("PK_UserPhoneNumbers", "PK_UserPhoneNumbers");
migrationBuilder.RenameIndex(
    "IX_UserPhoneNumber_ApplicationUserId",
    "IX_UserPhoneNumbers_ApplicationUserId");
```

### 4. ????? Performance Indexes

```csharp
// Single column indexes on date fields
migrationBuilder.CreateIndex("IX_Employees_HireDate", "Employees", "HireDate");
migrationBuilder.CreateIndex("IX_JournalEntries_EntryDate", "JournalEntries", "EntryDate");
migrationBuilder.CreateIndex("IX_Orders_OrderDate", "Orders", "OrderDate");
migrationBuilder.CreateIndex("IX_Expenses_ExpenseDate", "Expenses", "ExpenseDate");
migrationBuilder.CreateIndex("IX_Purchases_PurchaseDate", "Purchases", "PurchaseDate");
migrationBuilder.CreateIndex("IX_Batches_CreatedAt", "Batches", "CreatedAt");
migrationBuilder.CreateIndex("IX_StockMovements_CreatedAt", "StockMovements", "CreatedAt");

// Composite indexes for multi-tenant queries
migrationBuilder.CreateIndex(
    "IX_Orders_BrandId_OrderDate",
    "Orders",
    new[] { "BrandId", "OrderDate" });

migrationBuilder.CreateIndex(
    "IX_Purchases_BrandId_PurchaseDate",
    "Purchases",
    new[] { "BrandId", "PurchaseDate" });

migrationBuilder.CreateIndex(
    "IX_Expenses_BrandId_ExpenseDate",
    "Expenses",
    new[] { "BrandId", "ExpenseDate" });

migrationBuilder.CreateIndex(
    "IX_JournalEntries_BrandId_EntryDate",
    "JournalEntries",
    new[] { "BrandId", "EntryDate" });
```

---

## ?? ????? ????????

| ??????? | ??? (v1) | ??? (v2 - ??????) | ?????? ??????? |
|--------|----------|------------|---------|
| GETUTCDATE() | 7? | 0? | ? 100% |
| Index Filters | 2? | 0? | ? 100% |
| UserPhoneNumber | 1? | 0? | ? 100% |
| ApplicationUserId | 1? | 1? | ? 0% |
| **???????** | **11?** | **1?** | **? 91%** |

---

## ?? ??????? ???????? ???????

### ApplicationUserId ?? BrandMemberships

```csharp
// ? ??? ?????? ?????? ????:
public Guid? ApplicationUserId { get; set; }

// ????????:
// 1. ????? ?????? (??????)
// 2. ????????? ??? ????? ?? UserId
// 3. ????? FK ???? ???
```

**???? ???????:** ????? ?? migration ????? ??? ?????? ?? ??? ?????????

---

## ?? ????? ???????

### 1. ????? Migration ??????

```powershell
# ?? Package Manager Console
Update-Database -Migration FixRemainingPostgreSQLIssues
```

### 2. ?????? ?? ???????

```sql
-- 1. ???? ?? ??? Default Values
SELECT column_name, column_default
FROM information_schema.columns
WHERE table_name = 'employees' AND column_name = 'hire_date';
-- Expected: now()

-- 2. ???? ?? ??? Indexes
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename IN ('customers', 'employees')
AND indexname LIKE 'IX_%UserId%';
-- Expected: "user_id" IS NOT NULL (PostgreSQL syntax)

-- 3. ???? ?? ???? UserPhoneNumbers
SELECT table_name
FROM information_schema.tables
WHERE table_name = 'user_phone_numbers';
-- Expected: ??? ?? ???? ?????

-- 4. ???? ?? ??? Indexes ???????
SELECT COUNT(*)
FROM pg_indexes
WHERE indexname LIKE 'IX_%_OrderDate%'
OR indexname LIKE 'IX_%_CreatedAt%';
-- Expected: >= 11 indexes
```

### 3. Build ?Test

```powershell
dotnet build  # ??? ?? ???? ???? errors
```

---

## ? ????? ??????

??? ???????:
- [ ] Backup ?? Database
- [ ] ???? ??? Initial Migration ??????
- [ ] ???? ??? ????? ???????

????? ???????:
- [ ] ???? Update-Database
- [ ] ?? ???? errors

??? ???????:
- [ ] ???? ??? SQL verification queries
- [ ] Build successful
- [ ] Application ????

---

## ?? ?????? ????????

```
??? ????? Migration ??????:

? GETUTCDATE() ? NOW() (7 ?????)
? Index Filters (PostgreSQL syntax)
? UserPhoneNumbers (????? ???????)
? Performance Indexes (11+ indexes)
?? ApplicationUserId (???? ????)

?????? ???????: 91% ?????
???????: 9/10 ?????
```

---

## ?? ??????? ????

1. **Rollback Support:** Migration ???? ?? Down() ?????
2. **Performance:** ????? indexes ??? ???? date columns
3. **Multi-tenant:** Composite indexes ?? BrandId + Date
4. **Naming:** ????? ???????? ???????

---

**??????:** ? ????? ??????? ??????  
**?????:** `Infrastructure/Migrations/20260216030000_FixRemainingPostgreSQLIssues.cs`  
**???????:** ????? 91% ?? ??????? ????????
