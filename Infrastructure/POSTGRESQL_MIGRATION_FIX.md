# ?? ?? ??????? ?????? ?? PostgreSQL Migration

## ?? ??????? ????????

### 1. ? GETUTCDATE() ?? PostgreSQL
**???????:**
```csharp
defaultValueSql: "GETUTCDATE()"  // SQL Server syntax ???
```

**????:**
```csharp
defaultValueSql: "NOW()"  // PostgreSQL syntax
```

**??????? ????????:**
- Employees.HireDate
- Orders.OrderDate
- Purchases.PurchaseDate
- Expenses.ExpenseDate
- JournalEntries.EntryDate
- StockMovements.CreatedAt
- Batches.CreatedAt

---

### 2. ? Filter Syntax ???? ??? Unique Indexes
**???????:**
```csharp
filter: "[UserId] IS NOT NULL"  // SQL Server syntax
```

**????:**
```csharp
filter: "\"UserId\" IS NOT NULL"  // PostgreSQL syntax
```

**??????? ????????:**
- Customers.UserId
- Employees.UserId

---

### 3. ? Default Values ??? ?????
**???????:**
```csharp
defaultValue: 0m      // Decimal notation ??? ?????
defaultValue: true    // Boolean literal
```

**????:**
```csharp
defaultValue: 0       // Integer
defaultValue: true    // Boolean (????)
```

**??????? ????????:**
- Orders.TotalAmount = 0m
- Purchases.TotalAmount = 0m
- Customers.LoyaltyPoints = 0

---

### 4. ? ApplicationUserId ?????? ?? BrandMemberships
**???????:**
```csharp
public Guid? ApplicationUserId { get; set; }  // ???? ??????
FK: ApplicationUserId ? AspNetUsers.Id        // FK ????
FK: UserId ? AspNetUsers.Id                   // FK ????
```

**????:**
```csharp
// ??? ApplicationUserId ??????
// ???????? ?? FK ??? UserId ???
```

---

## ??? ??????? ?????????

### Step 1: ????? Migration ??????
```powershell
Add-Migration FixPostgreSQLCompatibility
Update-Database
```

### Step 2: ?????? ?? ???????
```sql
-- ?????? ?? Unique Indexes
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename IN ('customers', 'employees')
AND indexname LIKE 'IX_Customers_UserId%' 
OR indexname LIKE 'IX_Employees_UserId%';

-- ?????? ?? Default Values
SELECT column_name, column_default 
FROM information_schema.columns 
WHERE table_name IN ('employees', 'orders', 'purchases');

-- ?????? ?? Foreign Keys
SELECT constraint_name, table_name, column_name
FROM information_schema.constraint_column_usage
WHERE table_name = 'brand_memberships';
```

---

## ?? ???? ??????? ???????

| ??????? | ??????? ???????? | ???? | ???????? |
|--------|------------------|------|---------|
| GETUTCDATE() | 7 ????? | ????? ??? NOW() | ?? ???? |
| Filter Syntax | Customers, Employees | ??????? PostgreSQL syntax | ?? ???? |
| ApplicationUserId | BrandMemberships | ??? ?????? ???? FK | ?? ???? |
| Indexes ??? Date | 5 ????? | ????? indexes | ?? ???? |
| Composite Indexes | 3 ????? | ????? indexes | ?? ???? |

---

## ? ????????? ??? ???????

- [ ] Backup ?? PostgreSQL Database
- [ ] ?? ???? ?????? ?? ????? BrandMemberships
- [ ] ?? ???? foreign keys ?? ????? ???? ??? ApplicationUserId
- [ ] ????? ??? Application ??? ???????

---

## ?? ??????? ????????

### 1. Backup Database
```bash
# ?? PowerShell
pg_dump -h ep-calm-wave-a9rtyx43-pooler.gwc.azure.neon.tech -U neondb_owner neondb > backup.sql
```

### 2. ????? Migration
```powershell
# ?? Package Manager Console
Add-Migration FixPostgreSQLCompatibility
Update-Database
```

### 3. ?????? ?? ???????
```sql
-- ?? pgAdmin ?? psql
SELECT version();  -- ???? ?? PostgreSQL

-- ???? ?? ??? Indexes
SELECT * FROM pg_indexes WHERE tablename = 'customers';

-- ???? ?? Default Values
SELECT column_name, column_default 
FROM information_schema.columns 
WHERE table_name = 'employees' AND column_name = 'hire_date';
```

---

## ?? ??????? ????

### PostgreSQL vs SQL Server:
| ?????? | SQL Server | PostgreSQL |
|--------|-----------|-----------|
| Current Date/Time | `GETUTCDATE()` | `NOW()` |
| Unique Index Filter | `[column] IS NOT NULL` | `"column" IS NOT NULL` |
| Boolean Default | `0` (false) | `false` ?? `true` |
| Names Quoting | `[name]` | `"name"` |

### Data Types:
```csharp
// SQL Server
defaultValue: true        // SQL Server accepts this
defaultValue: 0m          // Decimal literal

// PostgreSQL
defaultValue: true        // boolean
defaultValue: 0           // integer
```

---

## ?? ?????? ???????

??? ????? Migration:

```sql
-- 1. ???? ?? ??? ???? ApplicationUserId
SELECT * FROM information_schema.columns 
WHERE table_name = 'brand_memberships' 
AND column_name = 'application_user_id';

-- 2. ???? ?? ??? Indexes ???????
SELECT indexname FROM pg_indexes 
WHERE tablename = 'purchases' 
AND indexname LIKE '%PurchaseDate%';

-- 3. ???? ?? Default Values
SELECT column_name, column_default 
FROM information_schema.columns 
WHERE table_name = 'orders' 
AND column_name = 'total_amount';
```

---

## ?? ??? ???? ?????

### Rollback:
```powershell
Update-Database -Migration 20260216010405_InitialCreate
```

### ???? ?????? (??? ??? Rollback):
```sql
-- ????? ???? ?? ???? pgAdmin
-- 1. ??? ??? Index
DROP INDEX IF EXISTS ix_customers_user_id;

-- 2. ????? ????? ??? Index ???????? ???????
CREATE UNIQUE INDEX ix_customers_user_id 
ON customers("user_id") 
WHERE "user_id" IS NOT NULL;

-- 3. ??? ?????? ??????
ALTER TABLE brand_memberships DROP COLUMN IF EXISTS application_user_id;
```

---

## ? ???????? ???????? ?? Migration ??????

### 1. ? Audit Columns
```sql
-- ????? UpdatedAt columns
ALTER TABLE products ADD COLUMN updated_at timestamp with time zone;
ALTER TABLE purchases ADD COLUMN updated_at timestamp with time zone;
ALTER TABLE orders ADD COLUMN updated_at timestamp with time zone;
```

### 2. ? Performance Indexes
```sql
-- Indexes ??? Date Columns
CREATE INDEX ix_purchases_purchase_date ON purchases(purchase_date);
CREATE INDEX ix_orders_order_date ON orders(order_date);

-- Composite Indexes ?? Multi-Tenant Queries
CREATE INDEX ix_purchases_brand_id_purchase_date ON purchases(brand_id, purchase_date);
CREATE INDEX ix_orders_brand_id_order_date ON orders(brand_id, order_date);
```

---

## ?? ??????? ????????

??? ????? Migration:

? PostgreSQL syntax ????  
? Unique Constraints ?????  
? BrandMemberships ????? ???? ApplicationUserId  
? Performance Indexes ??????  
? Audit Columns ????? ?????????  
? Database ?????? ?? .NET 10  

---

**??????:** ?? Ready for Application  
**??? ?????:** ????  
**????????:** ?? ???? - ???? ?????
